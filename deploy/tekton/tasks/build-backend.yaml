wapiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: build-backend
  labels:
    app.kubernetes.io/name: crm
    app.kubernetes.io/component: pipeline
spec:
  description: Build and push the CRM backend Docker image

  params:
    - name: git-url
      type: string
      description: Git repository URL
    - name: git-revision
      type: string
      description: Git revision to checkout
      default: main
    - name: image-name
      type: string
      description: Name of the image to build
      default: crm-backend
    - name: image-tag
      type: string
      description: Tag for the image
      default: latest
    - name: registry
      type: string
      description: Container registry
      default: image-registry.openshift-image-registry.svc:5000
    - name: namespace
      type: string
      description: Namespace for the image
      default: crm-dev

  workspaces:
    - name: source
      description: Workspace containing the source code
    - name: dockerconfig
      description: Docker config for registry authentication
      optional: true

  results:
    - name: image-digest
      description: Digest of the built image
    - name: image-url
      description: Full URL of the built image

  steps:
    - name: git-clone
      image: alpine/git:latest
      script: |
        #!/usr/bin/env sh
        set -eu

        # Ensure workspace is clean
        if [ -d "$(workspaces.source.path)" ]; then
          rm -rf "$(workspaces.source.path)"/*
        fi
        mkdir -p "$(workspaces.source.path)"

        echo "Cloning $(params.git-url) at revision $(params.git-revision)"
        git clone --depth 1 --branch $(params.git-revision) $(params.git-url) $(workspaces.source.path)

        cd $(workspaces.source.path)
        echo "Checked out commit: $(git -c safe.directory=$(workspaces.source.path) rev-parse HEAD)"
      securityContext:
        runAsNonRoot: true

    - name: prepare-dockerconfig
      image: alpine:3.19
      script: |
        #!/usr/bin/env sh
        set -eu
        mkdir -p /workspace/.docker
        if [ -f "$(workspaces.dockerconfig.path)/.dockercfg" ]; then
          echo '{"auths":' > /workspace/.docker/config.json
          cat "$(workspaces.dockerconfig.path)/.dockercfg" >> /workspace/.docker/config.json
          echo '}' >> /workspace/.docker/config.json
        elif [ -f "$(workspaces.dockerconfig.path)/config.json" ]; then
          cp "$(workspaces.dockerconfig.path)/config.json" \
             "/workspace/.docker/config.json"
        fi

    - name: build-and-push
      image: quay.io/openshift/origin-cli:4.14
      script: |
        #!/usr/bin/env sh
        set -eu

        NAMESPACE=$(params.namespace)
        TAG=$(params.image-tag)

        echo "Starting OpenShift Binary Build: crm-backend in namespace ${NAMESPACE}"
        oc start-build -n "${NAMESPACE}" crm-backend --from-dir=$(workspaces.source.path) --follow

        echo "Fetching built image reference..."
        IMAGE_REF=$(oc get istag -n "${NAMESPACE}" crm-backend:${TAG} -o jsonpath='{.image.dockerImageReference}')
        echo "Built image: ${IMAGE_REF}"

        echo "${IMAGE_REF}" | tee $(results.image-url.path)
        DIGEST=$(echo "${IMAGE_REF}" | awk -F@ '{print $2}')
        [ -n "${DIGEST}" ] && echo "${DIGEST}" | tee $(results.image-digest.path) || echo "" | tee $(results.image-digest.path)
    - name: write-results
      image: alpine:3.19
      script: |
        #!/usr/bin/env sh
        set -eu
        cat /tmp/image-digest | tee $(results.image-digest.path)
        echo -n "$(params.registry)/$(params.namespace)/$(params.image-name):$(params.image-tag)" | tee $(results.image-url.path)
      resources:
        requests:
          memory: "1Gi"
          cpu: "500m"
        limits:
          memory: "2Gi"
          cpu: "1000m"

  volumes: []
